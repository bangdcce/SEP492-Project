import { MigrationInterface, QueryRunner } from 'typeorm';

export class DisputedHearing1768714431530 implements MigrationInterface {
  name = 'DisputedHearing1768714431530';

  public async up(queryRunner: QueryRunner): Promise<void> {
    await queryRunner.query(
      `ALTER TABLE "project_specs" DROP CONSTRAINT "project_specs_requestId_fkey"`,
    );
    await queryRunner.query(
      `ALTER TABLE "broker_proposals" DROP CONSTRAINT "FK_broker_proposals_broker"`,
    );
    await queryRunner.query(
      `ALTER TABLE "broker_proposals" DROP CONSTRAINT "FK_broker_proposals_request"`,
    );
    await queryRunner.query(`DROP INDEX "public"."IDX_broker_proposal_request_broker"`);
    await queryRunner.query(
      `CREATE TYPE "public"."user_availabilities_type_enum" AS ENUM('AVAILABLE', 'BUSY', 'OUT_OF_OFFICE', 'PREFERRED', 'DO_NOT_DISTURB')`,
    );
    await queryRunner.query(
      `CREATE TABLE "user_availabilities" ("id" uuid NOT NULL DEFAULT uuid_generate_v4(), "userId" uuid NOT NULL, "startTime" TIMESTAMP, "endTime" TIMESTAMP, "type" "public"."user_availabilities_type_enum" NOT NULL, "isRecurring" boolean NOT NULL DEFAULT false, "dayOfWeek" integer, "recurringStartTime" TIME, "recurringEndTime" TIME, "recurringStartDate" date, "recurringEndDate" date, "isAutoGenerated" boolean NOT NULL DEFAULT false, "linkedEventId" uuid, "note" text, "createdAt" TIMESTAMP NOT NULL DEFAULT now(), "updatedAt" TIMESTAMP NOT NULL DEFAULT now(), CONSTRAINT "PK_8bc9ab5a97c0d7ac41a57888d2c" PRIMARY KEY ("id")); COMMENT ON COLUMN "user_availabilities"."startTime" IS 'Thời gian bắt đầu (cho one-time)'; COMMENT ON COLUMN "user_availabilities"."endTime" IS 'Thời gian kết thúc (cho one-time)'; COMMENT ON COLUMN "user_availabilities"."dayOfWeek" IS 'Ngày trong tuần (0=CN, 1=T2, 2=T3...)'; COMMENT ON COLUMN "user_availabilities"."recurringStartTime" IS 'Giờ bắt đầu recurring (08:00)'; COMMENT ON COLUMN "user_availabilities"."recurringEndTime" IS 'Giờ kết thúc recurring (17:00)'; COMMENT ON COLUMN "user_availabilities"."recurringStartDate" IS 'Ngày bắt đầu hiệu lực của recurring'; COMMENT ON COLUMN "user_availabilities"."recurringEndDate" IS 'Ngày kết thúc hiệu lực (null = vĩnh viễn)'; COMMENT ON COLUMN "user_availabilities"."isAutoGenerated" IS 'TRUE = Tự động tạo từ CalendarEvent'; COMMENT ON COLUMN "user_availabilities"."linkedEventId" IS 'CalendarEvent đã tạo availability này'; COMMENT ON COLUMN "user_availabilities"."note" IS 'Ghi chú (Họp nội bộ, Nghỉ phép...)'`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_ac1cbe4c27fbb852c69edc736d" ON "user_availabilities" ("userId", "type") `,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_e377a1b2968a22e35e20494d50" ON "user_availabilities" ("userId", "startTime", "endTime") `,
    );
    await queryRunner.query(
      `CREATE TABLE "staff_performances" ("id" uuid NOT NULL DEFAULT uuid_generate_v4(), "staffId" uuid NOT NULL, "period" character varying(7) NOT NULL, "totalDisputesAssigned" integer NOT NULL DEFAULT '0', "totalDisputesResolved" integer NOT NULL DEFAULT '0', "totalDisputesPending" integer NOT NULL DEFAULT '0', "totalAppealed" integer NOT NULL DEFAULT '0', "totalOverturnedByAdmin" integer NOT NULL DEFAULT '0', "appealRate" numeric(5,2) NOT NULL DEFAULT '0', "overturnRate" numeric(5,2) NOT NULL DEFAULT '0', "avgResolutionTimeHours" numeric(10,2) NOT NULL DEFAULT '0', "avgUserRating" numeric(3,2), "totalUserRatings" integer NOT NULL DEFAULT '0', "totalHearingsConducted" integer NOT NULL DEFAULT '0', "totalHearingsRescheduled" integer NOT NULL DEFAULT '0', "createdAt" TIMESTAMP NOT NULL DEFAULT now(), "updatedAt" TIMESTAMP NOT NULL DEFAULT now(), CONSTRAINT "PK_03c57f7ad04ac58124e1ff1940c" PRIMARY KEY ("id")); COMMENT ON COLUMN "staff_performances"."staffId" IS 'User có role = STAFF'; COMMENT ON COLUMN "staff_performances"."period" IS 'YYYY-MM (e.g., 2026-01) hoặc YYYY-QX'; COMMENT ON COLUMN "staff_performances"."totalDisputesAssigned" IS 'Số vụ được gán trong kỳ'; COMMENT ON COLUMN "staff_performances"."totalDisputesResolved" IS 'Số vụ đã xử lý xong'; COMMENT ON COLUMN "staff_performances"."totalDisputesPending" IS 'Số vụ đang pending'; COMMENT ON COLUMN "staff_performances"."totalAppealed" IS 'Số vụ bị kháng cáo'; COMMENT ON COLUMN "staff_performances"."totalOverturnedByAdmin" IS 'Số vụ bị Admin đảo ngược quyết định'; COMMENT ON COLUMN "staff_performances"."appealRate" IS '% bị appeal = totalAppealed/totalResolved * 100'; COMMENT ON COLUMN "staff_performances"."overturnRate" IS '% bị đảo = totalOverturned/totalAppealed * 100'; COMMENT ON COLUMN "staff_performances"."avgResolutionTimeHours" IS 'Thời gian xử lý trung bình (giờ)'; COMMENT ON COLUMN "staff_performances"."avgUserRating" IS 'Rating trung bình từ user (1.00-5.00)'; COMMENT ON COLUMN "staff_performances"."totalUserRatings" IS 'Số lượt rating từ user'; COMMENT ON COLUMN "staff_performances"."totalHearingsConducted" IS 'Số phiên điều trần đã chủ trì'; COMMENT ON COLUMN "staff_performances"."totalHearingsRescheduled" IS 'Số phiên bị reschedule (do Staff)'`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_f470385602469dc1fb0615d4c6" ON "staff_performances" ("staffId", "period") `,
    );
    await queryRunner.query(
      `CREATE TABLE "staff_workloads" ("id" uuid NOT NULL DEFAULT uuid_generate_v4(), "staffId" uuid NOT NULL, "date" date NOT NULL, "totalEventsScheduled" integer NOT NULL DEFAULT '0', "totalDisputesPending" integer NOT NULL DEFAULT '0', "scheduledMinutes" integer NOT NULL DEFAULT '0', "dailyCapacityMinutes" integer NOT NULL DEFAULT '480', "utilizationRate" numeric(5,2) NOT NULL DEFAULT '0', "isOverloaded" boolean NOT NULL DEFAULT false, "canAcceptNewEvent" boolean NOT NULL DEFAULT true, "isOnLeave" boolean NOT NULL DEFAULT false, "updatedAt" TIMESTAMP NOT NULL DEFAULT now(), CONSTRAINT "PK_3df5dac98d0a3901160284e55c1" PRIMARY KEY ("id")); COMMENT ON COLUMN "staff_workloads"."staffId" IS 'User có role = STAFF'; COMMENT ON COLUMN "staff_workloads"."date" IS 'Ngày tính workload'; COMMENT ON COLUMN "staff_workloads"."totalEventsScheduled" IS 'Số event đã lên lịch trong ngày'; COMMENT ON COLUMN "staff_workloads"."totalDisputesPending" IS 'Số dispute đang xử lý (tổng thể - chưa resolve)'; COMMENT ON COLUMN "staff_workloads"."scheduledMinutes" IS 'Tổng số phút đã book trong ngày'; COMMENT ON COLUMN "staff_workloads"."dailyCapacityMinutes" IS 'Sức chứa tối đa (default 8h = 480 phút)'; COMMENT ON COLUMN "staff_workloads"."utilizationRate" IS '= scheduledMinutes / dailyCapacityMinutes * 100'; COMMENT ON COLUMN "staff_workloads"."isOverloaded" IS 'TRUE = utilizationRate > 90%'; COMMENT ON COLUMN "staff_workloads"."canAcceptNewEvent" IS 'TRUE = có thể nhận thêm việc (utilizationRate < 80%)'; COMMENT ON COLUMN "staff_workloads"."isOnLeave" IS 'TRUE = Staff đánh dấu nghỉ ngày này'`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_6ea8194aa51f091685b7189c83" ON "staff_workloads" ("staffId", "date") `,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."legal_signatures_actiontype_enum" AS ENUM('CREATE_DISPUTE', 'ACCEPT_SETTLEMENT', 'ACCEPT_VERDICT', 'APPEAL_SUBMISSION', 'WITHDRAW_DISPUTE')`,
    );
    await queryRunner.query(
      `CREATE TABLE "legal_signatures" ("id" uuid NOT NULL DEFAULT uuid_generate_v4(), "disputeId" uuid NOT NULL, "signerId" uuid NOT NULL, "signerRole" character varying NOT NULL, "actionType" "public"."legal_signatures_actiontype_enum" NOT NULL, "termsContentSnapshot" text NOT NULL, "termsVersion" character varying(10) NOT NULL, "referenceType" character varying, "referenceId" character varying, "ipAddress" character varying(45) NOT NULL, "userAgent" text NOT NULL, "deviceFingerprint" character varying(64), "signedAt" TIMESTAMP NOT NULL DEFAULT now(), CONSTRAINT "PK_f43925e14ba327e052d0de59352" PRIMARY KEY ("id")); COMMENT ON COLUMN "legal_signatures"."signerRole" IS 'Role lúc ký'; COMMENT ON COLUMN "legal_signatures"."termsContentSnapshot" IS 'Snapshot nội dung điều khoản User đã đọc lúc bấm nút'; COMMENT ON COLUMN "legal_signatures"."termsVersion" IS 'Version của điều khoản'; COMMENT ON COLUMN "legal_signatures"."ipAddress" IS 'IP Address của User lúc ký'; COMMENT ON COLUMN "legal_signatures"."userAgent" IS 'Trình duyệt/Thiết bị lúc ký'; COMMENT ON COLUMN "legal_signatures"."deviceFingerprint" IS 'Browser fingerprint hash (optional)'; COMMENT ON COLUMN "legal_signatures"."signedAt" IS 'Thời điểm pháp lý có hiệu lực (Immutable)'`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_e8063ccf1d8a6844462602e379" ON "legal_signatures" ("disputeId", "signerId") `,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."event_participants_role_enum" AS ENUM('ORGANIZER', 'MODERATOR', 'REQUIRED', 'OPTIONAL', 'OBSERVER')`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."event_participants_status_enum" AS ENUM('PENDING', 'ACCEPTED', 'DECLINED', 'TENTATIVE', 'NO_RESPONSE')`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."event_participants_attendancestatus_enum" AS ENUM('NOT_STARTED', 'ON_TIME', 'LATE', 'VERY_LATE', 'NO_SHOW', 'EXCUSED')`,
    );
    await queryRunner.query(
      `CREATE TABLE "event_participants" ("id" uuid NOT NULL DEFAULT uuid_generate_v4(), "eventId" uuid NOT NULL, "userId" uuid NOT NULL, "role" "public"."event_participants_role_enum" NOT NULL, "status" "public"."event_participants_status_enum" NOT NULL DEFAULT 'PENDING', "responseDeadline" TIMESTAMP, "respondedAt" TIMESTAMP, "responseNote" text, "attendanceStatus" "public"."event_participants_attendancestatus_enum" NOT NULL DEFAULT 'NOT_STARTED', "joinedAt" TIMESTAMP, "leftAt" TIMESTAMP, "isOnline" boolean NOT NULL DEFAULT false, "lateMinutes" integer, "excuseReason" text, "excuseApproved" boolean NOT NULL DEFAULT false, "createdAt" TIMESTAMP NOT NULL DEFAULT now(), CONSTRAINT "PK_b65ffd558d76fd51baffe81d42b" PRIMARY KEY ("id")); COMMENT ON COLUMN "event_participants"."responseDeadline" IS 'Hạn phản hồi lời mời'; COMMENT ON COLUMN "event_participants"."responseNote" IS 'Lý do từ chối/ghi chú'; COMMENT ON COLUMN "event_participants"."joinedAt" IS 'Thời điểm vào event'; COMMENT ON COLUMN "event_participants"."leftAt" IS 'Thời điểm rời event'; COMMENT ON COLUMN "event_participants"."lateMinutes" IS 'Số phút trễ (nếu LATE)'`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_845042ee2b14702b78b0428d19" ON "event_participants" ("userId", "status") `,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_7d90a2ab3ea972461a2b698adc" ON "event_participants" ("eventId", "userId") `,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."dispute_messages_type_enum" AS ENUM('TEXT', 'IMAGE', 'FILE', 'EVIDENCE_LINK', 'SYSTEM_LOG', 'SETTLEMENT_PROPOSAL', 'ADMIN_ANNOUNCEMENT')`,
    );
    await queryRunner.query(
      `CREATE TABLE "dispute_messages" ("id" uuid NOT NULL DEFAULT uuid_generate_v4(), "disputeId" uuid NOT NULL, "senderId" uuid, "senderRole" character varying NOT NULL, "type" "public"."dispute_messages_type_enum" NOT NULL DEFAULT 'TEXT', "content" text, "replyToMessageId" uuid, "relatedEvidenceId" uuid, "hearingId" uuid, "metadata" jsonb, "isHidden" boolean NOT NULL DEFAULT false, "hiddenReason" text, "hiddenById" character varying, "hiddenAt" TIMESTAMP, "createdAt" TIMESTAMP NOT NULL DEFAULT now(), CONSTRAINT "PK_8826f78d556a1846f8cbad5ed05" PRIMARY KEY ("id")); COMMENT ON COLUMN "dispute_messages"."senderId" IS 'User ID (null = System message)'; COMMENT ON COLUMN "dispute_messages"."senderRole" IS 'Role lúc gửi: CLIENT/FREELANCER/BROKER/STAFF/ADMIN/SYSTEM'; COMMENT ON COLUMN "dispute_messages"."content" IS 'Nội dung chat text'; COMMENT ON COLUMN "dispute_messages"."replyToMessageId" IS 'Reply tin nhắn nào?'; COMMENT ON COLUMN "dispute_messages"."relatedEvidenceId" IS 'Tin nhắn này đang bàn luận về bằng chứng nào?'; COMMENT ON COLUMN "dispute_messages"."hearingId" IS 'Phiên điều trần (nếu chat trong hearing)'; COMMENT ON COLUMN "dispute_messages"."isHidden" IS 'Admin ẩn tin nhắn này'`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_b00e523249685dadae620f80e4" ON "dispute_messages" ("senderId", "createdAt") `,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_a9cbc17b602d6612732446411e" ON "dispute_messages" ("disputeId", "createdAt") `,
    );
    await queryRunner.query(
      `CREATE TABLE "dispute_evidences" ("id" uuid NOT NULL DEFAULT uuid_generate_v4(), "disputeId" uuid NOT NULL, "uploaderId" uuid NOT NULL, "uploaderRole" character varying NOT NULL, "storagePath" character varying NOT NULL, "fileName" character varying NOT NULL, "fileSize" integer NOT NULL, "mimeType" character varying NOT NULL, "description" text, "fileHash" character varying(64), "isFlagged" boolean NOT NULL DEFAULT false, "flagReason" text, "flaggedById" uuid, "flaggedAt" TIMESTAMP, "uploadedAt" TIMESTAMP NOT NULL DEFAULT now(), CONSTRAINT "PK_5303a0ad975cf37cc0303bc831e" PRIMARY KEY ("id")); COMMENT ON COLUMN "dispute_evidences"."uploaderId" IS 'Người upload bằng chứng'; COMMENT ON COLUMN "dispute_evidences"."uploaderRole" IS 'Role của người upload lúc đó (CLIENT/FREELANCER/STAFF/ADMIN)'; COMMENT ON COLUMN "dispute_evidences"."storagePath" IS 'Đường dẫn file trong Supabase Bucket (e.g., disputes/uuid/file.png)'; COMMENT ON COLUMN "dispute_evidences"."fileName" IS 'Tên file gốc người dùng upload (để hiển thị trên UI)'; COMMENT ON COLUMN "dispute_evidences"."fileSize" IS 'Dung lượng file tính bằng bytes'; COMMENT ON COLUMN "dispute_evidences"."mimeType" IS 'MIME Type chi tiết (image/jpeg, application/pdf...)'; COMMENT ON COLUMN "dispute_evidences"."description" IS 'Mô tả ngắn cho bằng chứng (Caption)'; COMMENT ON COLUMN "dispute_evidences"."fileHash" IS 'SHA-256 hash để verify integrity'; COMMENT ON COLUMN "dispute_evidences"."isFlagged" IS 'TRUE = Admin ẩn do nhạy cảm (Soft Hide)'; COMMENT ON COLUMN "dispute_evidences"."flagReason" IS 'Lý do bị ẩn (VD: Mã độc, Ảnh fake)'; COMMENT ON COLUMN "dispute_evidences"."flaggedById" IS 'Admin/Staff đã flag'; COMMENT ON COLUMN "dispute_evidences"."uploadedAt" IS 'Thời điểm upload bằng chứng (Immutable)'`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_de7b1e3103a486f694fedc726f" ON "dispute_evidences" ("disputeId", "uploadedAt") `,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."event_reschedule_requests_status_enum" AS ENUM('PENDING', 'APPROVED', 'REJECTED', 'AUTO_RESOLVED', 'WITHDRAWN')`,
    );
    await queryRunner.query(
      `CREATE TABLE "event_reschedule_requests" ("id" uuid NOT NULL DEFAULT uuid_generate_v4(), "eventId" uuid NOT NULL, "requesterId" uuid NOT NULL, "reason" text NOT NULL, "proposedTimeSlots" jsonb, "useAutoSchedule" boolean NOT NULL DEFAULT false, "status" "public"."event_reschedule_requests_status_enum" NOT NULL DEFAULT 'PENDING', "processedById" uuid, "processedAt" TIMESTAMP, "processNote" text, "newEventId" uuid, "selectedNewStartTime" TIMESTAMP, "createdAt" TIMESTAMP NOT NULL DEFAULT now(), CONSTRAINT "PK_64eb192a85910c5ea6081d06560" PRIMARY KEY ("id")); COMMENT ON COLUMN "event_reschedule_requests"."requesterId" IS 'Người yêu cầu dời lịch'; COMMENT ON COLUMN "event_reschedule_requests"."reason" IS 'Lý do xin dời lịch'; COMMENT ON COLUMN "event_reschedule_requests"."proposedTimeSlots" IS 'Các khung giờ user đề xuất (tối đa 3)'; COMMENT ON COLUMN "event_reschedule_requests"."useAutoSchedule" IS 'TRUE = Để hệ thống tự tìm giờ phù hợp'; COMMENT ON COLUMN "event_reschedule_requests"."processedById" IS 'Staff/Admin xử lý'; COMMENT ON COLUMN "event_reschedule_requests"."processNote" IS 'Ghi chú khi approve/reject'; COMMENT ON COLUMN "event_reschedule_requests"."newEventId" IS 'Event mới được tạo (nếu approved)'; COMMENT ON COLUMN "event_reschedule_requests"."selectedNewStartTime" IS 'Thời gian mới được chọn'`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_3108804238a667da7d826fba4b" ON "event_reschedule_requests" ("eventId", "status") `,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."calendar_events_type_enum" AS ENUM('DISPUTE_HEARING', 'PROJECT_MEETING', 'INTERNAL_MEETING', 'PERSONAL_BLOCK', 'REVIEW_SESSION', 'OTHER')`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."calendar_events_priority_enum" AS ENUM('LOW', 'MEDIUM', 'HIGH', 'URGENT')`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."calendar_events_status_enum" AS ENUM('DRAFT', 'PENDING_CONFIRMATION', 'SCHEDULED', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED', 'RESCHEDULING')`,
    );
    await queryRunner.query(
      `CREATE TABLE "calendar_events" ("id" uuid NOT NULL DEFAULT uuid_generate_v4(), "type" "public"."calendar_events_type_enum" NOT NULL, "title" character varying(255) NOT NULL, "description" text, "priority" "public"."calendar_events_priority_enum" NOT NULL DEFAULT 'MEDIUM', "status" "public"."calendar_events_status_enum" NOT NULL DEFAULT 'DRAFT', "startTime" TIMESTAMP NOT NULL, "endTime" TIMESTAMP NOT NULL, "durationMinutes" integer NOT NULL, "organizerId" uuid NOT NULL, "referenceType" character varying(50), "referenceId" character varying, "isAutoScheduled" boolean NOT NULL DEFAULT false, "autoScheduleRuleId" character varying, "rescheduleCount" integer NOT NULL DEFAULT '0', "previousEventId" uuid, "lastRescheduledAt" TIMESTAMP, "location" character varying, "externalMeetingLink" character varying, "reminderMinutes" jsonb, "notes" text, "metadata" jsonb, "createdAt" TIMESTAMP NOT NULL DEFAULT now(), "updatedAt" TIMESTAMP NOT NULL DEFAULT now(), CONSTRAINT "PK_faf5391d232322a87cdd1c6f30c" PRIMARY KEY ("id")); COMMENT ON COLUMN "calendar_events"."durationMinutes" IS 'Thời lượng (phút)'; COMMENT ON COLUMN "calendar_events"."organizerId" IS 'Người tạo event (Staff/Admin/User)'; COMMENT ON COLUMN "calendar_events"."referenceType" IS 'DisputeHearing, Project, Task...'; COMMENT ON COLUMN "calendar_events"."isAutoScheduled" IS 'TRUE = Hệ thống tự tạo'; COMMENT ON COLUMN "calendar_events"."autoScheduleRuleId" IS 'Rule đã dùng để auto-schedule'; COMMENT ON COLUMN "calendar_events"."rescheduleCount" IS 'Số lần đã dời lịch (Max 2-3)'; COMMENT ON COLUMN "calendar_events"."previousEventId" IS 'Event cũ nếu là reschedule'; COMMENT ON COLUMN "calendar_events"."location" IS 'Online, Room A, etc.'; COMMENT ON COLUMN "calendar_events"."externalMeetingLink" IS 'Link Google Meet/Zoom nếu online (bên thứ 3)'; COMMENT ON COLUMN "calendar_events"."reminderMinutes" IS 'Cấu hình nhắc nhở [15, 60, 1440] phút trước'`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_764bd953684c413eea5bd3059a" ON "calendar_events" ("status", "startTime") `,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_11c123605d5b0aa135a5283321" ON "calendar_events" ("organizerId", "startTime") `,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_fb3f2230a784122307b26d18a3" ON "calendar_events" ("startTime", "endTime") `,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."dispute_settlements_status_enum" AS ENUM('PENDING', 'ACCEPTED', 'REJECTED', 'EXPIRED', 'CANCELLED')`,
    );
    await queryRunner.query(
      `CREATE TABLE "dispute_settlements" ("id" uuid NOT NULL DEFAULT uuid_generate_v4(), "disputeId" uuid NOT NULL, "proposerId" uuid NOT NULL, "proposerRole" character varying NOT NULL, "amountToFreelancer" numeric(15,2) NOT NULL, "amountToClient" numeric(15,2) NOT NULL, "platformFee" numeric(15,2) NOT NULL DEFAULT '0', "terms" text, "status" "public"."dispute_settlements_status_enum" NOT NULL DEFAULT 'PENDING', "responderId" uuid, "respondedAt" TIMESTAMP, "rejectedReason" text, "expiresAt" TIMESTAMP, "createdAt" TIMESTAMP NOT NULL DEFAULT now(), "updatedAt" TIMESTAMP NOT NULL DEFAULT now(), CONSTRAINT "PK_c93a0d89d516eeea1ffe9b40887" PRIMARY KEY ("id")); COMMENT ON COLUMN "dispute_settlements"."proposerId" IS 'Người đưa ra đề xuất hòa giải'; COMMENT ON COLUMN "dispute_settlements"."proposerRole" IS 'Role của người đề xuất'; COMMENT ON COLUMN "dispute_settlements"."amountToFreelancer" IS 'Tiền chia cho Freelancer'; COMMENT ON COLUMN "dispute_settlements"."amountToClient" IS 'Tiền trả lại Client'; COMMENT ON COLUMN "dispute_settlements"."platformFee" IS 'Phí platform (nếu có - tính từ amountToFreelancer)'; COMMENT ON COLUMN "dispute_settlements"."terms" IS 'Điều kiện/ghi chú kèm theo đề xuất'; COMMENT ON COLUMN "dispute_settlements"."responderId" IS 'Người phản hồi (bên còn lại)'; COMMENT ON COLUMN "dispute_settlements"."rejectedReason" IS 'Lý do từ chối (nếu rejected)'; COMMENT ON COLUMN "dispute_settlements"."expiresAt" IS 'Thời hạn phản hồi (24-48h)'; COMMENT ON COLUMN "dispute_settlements"."updatedAt" IS 'Thời điểm chốt deal (Dùng để log Transaction)'`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_dac8e51dee0245e76de7099fc5" ON "dispute_settlements" ("disputeId", "status") `,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."auto_schedule_rules_eventtype_enum" AS ENUM('DISPUTE_HEARING', 'PROJECT_MEETING', 'INTERNAL_MEETING', 'PERSONAL_BLOCK', 'REVIEW_SESSION', 'OTHER')`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."auto_schedule_rules_strategy_enum" AS ENUM('BALANCED', 'URGENT_FIRST', 'ROUND_ROBIN', 'LEAST_BUSY')`,
    );
    await queryRunner.query(
      `CREATE TABLE "auto_schedule_rules" ("id" uuid NOT NULL DEFAULT uuid_generate_v4(), "name" character varying(100) NOT NULL, "description" text, "eventType" "public"."auto_schedule_rules_eventtype_enum" NOT NULL, "strategy" "public"."auto_schedule_rules_strategy_enum" NOT NULL DEFAULT 'BALANCED', "defaultDurationMinutes" integer NOT NULL DEFAULT '60', "bufferMinutes" integer NOT NULL DEFAULT '15', "maxStaffUtilizationRate" integer NOT NULL DEFAULT '80', "maxEventsPerStaffPerDay" integer NOT NULL DEFAULT '5', "workingHoursStart" TIME NOT NULL DEFAULT '08:00', "workingHoursEnd" TIME NOT NULL DEFAULT '18:00', "workingDays" jsonb NOT NULL DEFAULT '[1,2,3,4,5]', "respectUserPreferredSlots" boolean NOT NULL DEFAULT true, "avoidLunchHours" boolean NOT NULL DEFAULT true, "lunchStartTime" TIME DEFAULT '11:30', "lunchEndTime" TIME DEFAULT '13:00', "maxRescheduleCount" integer NOT NULL DEFAULT '2', "minRescheduleNoticeHours" integer NOT NULL DEFAULT '24', "autoAssignStaff" boolean NOT NULL DEFAULT true, "isActive" boolean NOT NULL DEFAULT true, "isDefault" boolean NOT NULL DEFAULT false, "createdAt" TIMESTAMP NOT NULL DEFAULT now(), "updatedAt" TIMESTAMP NOT NULL DEFAULT now(), CONSTRAINT "PK_30a7072435c9e07b25a34fc113a" PRIMARY KEY ("id")); COMMENT ON COLUMN "auto_schedule_rules"."eventType" IS 'Rule áp dụng cho loại event nào'; COMMENT ON COLUMN "auto_schedule_rules"."defaultDurationMinutes" IS 'Thời lượng mặc định (phút)'; COMMENT ON COLUMN "auto_schedule_rules"."bufferMinutes" IS 'Khoảng trống tối thiểu giữa 2 event (phút)'; COMMENT ON COLUMN "auto_schedule_rules"."maxStaffUtilizationRate" IS 'Staff chỉ nhận việc khi utilizationRate < X%'; COMMENT ON COLUMN "auto_schedule_rules"."maxEventsPerStaffPerDay" IS 'Số event tối đa mỗi Staff/ngày'; COMMENT ON COLUMN "auto_schedule_rules"."workingHoursStart" IS 'Giờ bắt đầu làm việc'; COMMENT ON COLUMN "auto_schedule_rules"."workingHoursEnd" IS 'Giờ kết thúc làm việc'; COMMENT ON COLUMN "auto_schedule_rules"."workingDays" IS 'Ngày làm việc (1=T2, 5=T6)'; COMMENT ON COLUMN "auto_schedule_rules"."respectUserPreferredSlots" IS 'Ưu tiên khung giờ user đánh dấu PREFERRED'; COMMENT ON COLUMN "auto_schedule_rules"."avoidLunchHours" IS 'Tránh giờ nghỉ trưa (11:30-13:00)'; COMMENT ON COLUMN "auto_schedule_rules"."maxRescheduleCount" IS 'Số lần dời lịch tối đa'; COMMENT ON COLUMN "auto_schedule_rules"."minRescheduleNoticeHours" IS 'Phải dời trước ít nhất X giờ'; COMMENT ON COLUMN "auto_schedule_rules"."autoAssignStaff" IS 'Tự động gán Staff khi tạo event'; COMMENT ON COLUMN "auto_schedule_rules"."isDefault" IS 'Rule mặc định cho eventType này'`,
    );
    await queryRunner.query(
      `CREATE TABLE "dispute_resolution_feedbacks" ("id" uuid NOT NULL DEFAULT uuid_generate_v4(), "disputeId" uuid NOT NULL, "staffId" uuid NOT NULL, "userId" uuid NOT NULL, "userRole" character varying NOT NULL, "rating" integer NOT NULL, "comment" text, "fairnessRating" integer, "responsivenessRating" integer, "professionalismRating" integer, "clarityRating" integer, "isSatisfied" boolean NOT NULL DEFAULT false, "isReported" boolean NOT NULL DEFAULT false, "createdAt" TIMESTAMP NOT NULL DEFAULT now(), CONSTRAINT "PK_5d209e71c3abd94cb28e26768f5" PRIMARY KEY ("id")); COMMENT ON COLUMN "dispute_resolution_feedbacks"."staffId" IS 'Staff đã xử lý dispute'; COMMENT ON COLUMN "dispute_resolution_feedbacks"."userId" IS 'User đánh giá (raiser hoặc defendant)'; COMMENT ON COLUMN "dispute_resolution_feedbacks"."userRole" IS 'Role của user khi đánh giá'; COMMENT ON COLUMN "dispute_resolution_feedbacks"."rating" IS 'Rating tổng thể (1-5 sao)'; COMMENT ON COLUMN "dispute_resolution_feedbacks"."comment" IS 'Nhận xét chi tiết (optional)'; COMMENT ON COLUMN "dispute_resolution_feedbacks"."fairnessRating" IS 'Công bằng trong xử lý (1-5)'; COMMENT ON COLUMN "dispute_resolution_feedbacks"."responsivenessRating" IS 'Tốc độ phản hồi (1-5)'; COMMENT ON COLUMN "dispute_resolution_feedbacks"."professionalismRating" IS 'Chuyên nghiệp (1-5)'; COMMENT ON COLUMN "dispute_resolution_feedbacks"."clarityRating" IS 'Giải thích rõ ràng (1-5)'; COMMENT ON COLUMN "dispute_resolution_feedbacks"."isSatisfied" IS 'User có hài lòng với kết quả?'; COMMENT ON COLUMN "dispute_resolution_feedbacks"."isReported" IS 'Feedback bị report (spam/không hợp lệ)'`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_7c5efa28f1cc59dcb589c07c90" ON "dispute_resolution_feedbacks" ("staffId", "createdAt") `,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_ae13f5b449f0c4eb0355461e25" ON "dispute_resolution_feedbacks" ("disputeId", "userId") `,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."dispute_verdicts_faulttype_enum" AS ENUM('NON_DELIVERY', 'QUALITY_MISMATCH', 'DEADLINE_MISSED', 'GHOSTING', 'SCOPE_CHANGE_CONFLICT', 'PAYMENT_ISSUE', 'FRAUD', 'MUTUAL_FAULT', 'NO_FAULT', 'OTHER')`,
    );
    await queryRunner.query(
      `CREATE TABLE "dispute_verdicts" ("id" uuid NOT NULL DEFAULT uuid_generate_v4(), "disputeId" uuid NOT NULL, "adjudicatorId" uuid NOT NULL, "adjudicatorRole" character varying NOT NULL, "faultType" "public"."dispute_verdicts_faulttype_enum" NOT NULL, "faultyParty" character varying NOT NULL, "reasoning" text NOT NULL, "amountToFreelancer" numeric(15,2) NOT NULL, "amountToClient" numeric(15,2) NOT NULL, "platformFee" numeric(15,2) NOT NULL DEFAULT '0', "trustScorePenalty" integer NOT NULL DEFAULT '0', "isBanTriggered" boolean NOT NULL DEFAULT false, "banDurationDays" integer NOT NULL DEFAULT '0', "warningMessage" text, "tier" integer NOT NULL DEFAULT '1', "isAppealVerdict" boolean NOT NULL DEFAULT false, "overridesVerdictId" uuid, "issuedAt" TIMESTAMP NOT NULL DEFAULT now(), CONSTRAINT "REL_a027522850799c0ff026bceb1c" UNIQUE ("disputeId"), CONSTRAINT "PK_7387005b86d6dddbe3db0af2bbb" PRIMARY KEY ("id")); COMMENT ON COLUMN "dispute_verdicts"."adjudicatorId" IS 'Staff/Admin ra phán quyết'; COMMENT ON COLUMN "dispute_verdicts"."adjudicatorRole" IS 'Role của người phán quyết (STAFF/ADMIN)'; COMMENT ON COLUMN "dispute_verdicts"."faultType" IS 'Lỗi thuộc về nhóm nào?'; COMMENT ON COLUMN "dispute_verdicts"."faultyParty" IS 'Bên bị xác định có lỗi chính (raiser/defendant/both/none)'; COMMENT ON COLUMN "dispute_verdicts"."reasoning" IS 'Lý giải chi tiết cho phán quyết'; COMMENT ON COLUMN "dispute_verdicts"."amountToFreelancer" IS 'Tiền chia cho Freelancer'; COMMENT ON COLUMN "dispute_verdicts"."amountToClient" IS 'Tiền trả lại Client'; COMMENT ON COLUMN "dispute_verdicts"."trustScorePenalty" IS 'Điểm Trust Score bị trừ (0-100)'; COMMENT ON COLUMN "dispute_verdicts"."isBanTriggered" IS 'Cấm user này hoạt động tạm thời?'; COMMENT ON COLUMN "dispute_verdicts"."banDurationDays" IS 'Số ngày bị cấm (nếu ban)'; COMMENT ON COLUMN "dispute_verdicts"."warningMessage" IS 'Cảnh cáo gửi cho bên có lỗi'; COMMENT ON COLUMN "dispute_verdicts"."tier" IS 'Tier 1 = Staff, Tier 2 = Admin (Appeal)'; COMMENT ON COLUMN "dispute_verdicts"."isAppealVerdict" IS 'TRUE = Đây là phán quyết override từ Admin'; COMMENT ON COLUMN "dispute_verdicts"."overridesVerdictId" IS 'Verdict ID bị override (nếu là appeal verdict)'; COMMENT ON COLUMN "dispute_verdicts"."issuedAt" IS 'Thời điểm ra phán quyết'`,
    );
    await queryRunner.query(`ALTER TABLE "dispute_hearings" DROP COLUMN "meetingLink"`);
    await queryRunner.query(`ALTER TABLE "disputes" ADD "assignedStaffId" uuid`);
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."assignedStaffId" IS 'Staff được gán xử lý'`,
    );
    await queryRunner.query(`ALTER TABLE "disputes" ADD "assignedAt" TIMESTAMP`);
    await queryRunner.query(
      `ALTER TABLE "disputes" ADD "currentTier" integer NOT NULL DEFAULT '1'`,
    );
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."currentTier" IS '1 = Staff xử lý, 2 = Admin phúc thẩm'`,
    );
    await queryRunner.query(`ALTER TABLE "disputes" ADD "escalatedToAdminId" uuid`);
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."escalatedToAdminId" IS 'Admin phúc thẩm (nếu escalate)'`,
    );
    await queryRunner.query(`ALTER TABLE "disputes" ADD "escalatedAt" TIMESTAMP`);
    await queryRunner.query(`ALTER TABLE "disputes" ADD "escalationReason" text`);
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."escalationReason" IS 'Lý do escalate lên Admin'`,
    );
    await queryRunner.query(`ALTER TABLE "disputes" ADD "acceptedSettlementId" character varying`);
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."acceptedSettlementId" IS 'Settlement đã được accept (nếu có)'`,
    );
    await queryRunner.query(
      `ALTER TABLE "disputes" ADD "isAutoResolved" boolean NOT NULL DEFAULT false`,
    );
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."isAutoResolved" IS 'TRUE = Auto-win do bị đơn không phản hồi'`,
    );
    await queryRunner.query(
      `ALTER TABLE "disputes" ADD "settlementAttempts" integer NOT NULL DEFAULT '0'`,
    );
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."settlementAttempts" IS 'Số lần đề xuất hòa giải bị reject (max 3)'`,
    );
    await queryRunner.query(`ALTER TABLE "disputes" ADD "appealDeadline" TIMESTAMP`);
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."appealDeadline" IS 'Hạn kháng cáo (3 ngày sau resolve)'`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_hearings" ADD "externalMeetingLink" character varying`,
    );
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."externalMeetingLink" IS 'Link Google Meet/Zoom nếu cần video call (optional, do bên thứ 3 cung cấp)'`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."dispute_hearings_currentspeakerrole_enum" AS ENUM('ALL', 'MODERATOR_ONLY', 'RAISER_ONLY', 'DEFENDANT_ONLY', 'MUTED_ALL')`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_hearings" ADD "currentSpeakerRole" "public"."dispute_hearings_currentspeakerrole_enum" NOT NULL DEFAULT 'MUTED_ALL'`,
    );
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."currentSpeakerRole" IS 'Kiểm soát ai được quyền chat hiện tại'`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."dispute_hearings_tier_enum" AS ENUM('TIER_1', 'TIER_2')`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_hearings" ADD "tier" "public"."dispute_hearings_tier_enum" NOT NULL DEFAULT 'TIER_1'`,
    );
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."tier" IS 'Tier 1 = Staff, Tier 2 = Admin phúc thẩm'`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_hearings" ADD "isChatRoomActive" boolean NOT NULL DEFAULT false`,
    );
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."isChatRoomActive" IS 'TRUE = Phòng chat đang hoạt động'`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_hearings" ADD "estimatedDurationMinutes" integer NOT NULL DEFAULT '60'`,
    );
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."estimatedDurationMinutes" IS 'Thời lượng dự kiến (phút)'`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_hearings" ADD "rescheduleCount" integer NOT NULL DEFAULT '0'`,
    );
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."rescheduleCount" IS 'Số lần đã dời lịch (Max 2-3)'`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_hearings" ADD "previousHearingId" character varying`,
    );
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."previousHearingId" IS 'Phiên cũ nếu đây là reschedule'`,
    );
    await queryRunner.query(`ALTER TABLE "dispute_hearings" ADD "lastRescheduledAt" TIMESTAMP`);
    await queryRunner.query(
      `ALTER TABLE "hearing_participants" ADD "isRequired" boolean NOT NULL DEFAULT false`,
    );
    await queryRunner.query(
      `COMMENT ON COLUMN "hearing_participants"."isRequired" IS 'Bắt buộc tham gia (Nguyên đơn, Bị đơn = true)'`,
    );
    await queryRunner.query(`ALTER TABLE "hearing_participants" ADD "responseDeadline" TIMESTAMP`);
    await queryRunner.query(
      `COMMENT ON COLUMN "hearing_participants"."responseDeadline" IS 'Hạn phản hồi lời mời'`,
    );
    await queryRunner.query(`ALTER TABLE "hearing_participants" ADD "declineReason" text`);
    await queryRunner.query(
      `COMMENT ON COLUMN "hearing_participants"."declineReason" IS 'Lý do từ chối/xin dời'`,
    );
    await queryRunner.query(`ALTER TABLE "milestones" ALTER COLUMN "amount" TYPE numeric(14,2)`);
    await queryRunner.query(
      `ALTER TYPE "public"."project_requests_status_enum" RENAME TO "project_requests_status_enum_old"`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."project_requests_status_enum" AS ENUM('PUBLIC_DRAFT', 'PRIVATE_DRAFT', 'BROKER_ASSIGNED', 'SPEC_APPROVED', 'CONTRACT_PENDING', 'HIRING', 'CONVERTED_TO_PROJECT', 'IN_PROGRESS', 'COMPLETED', 'CANCELED', 'DRAFT', 'PENDING', 'PENDING_SPECS', 'PROCESSING', 'APPROVED', 'REJECTED', 'CANCELLED', 'SPEC_SUBMITTED')`,
    );
    await queryRunner.query(`ALTER TABLE "project_requests" ALTER COLUMN "status" DROP DEFAULT`);
    await queryRunner.query(
      `ALTER TABLE "project_requests" ALTER COLUMN "status" TYPE "public"."project_requests_status_enum" USING "status"::"text"::"public"."project_requests_status_enum"`,
    );
    await queryRunner.query(
      `ALTER TABLE "project_requests" ALTER COLUMN "status" SET DEFAULT 'PENDING'`,
    );
    await queryRunner.query(`DROP TYPE "public"."project_requests_status_enum_old"`);
    await queryRunner.query(
      `ALTER TABLE "project_specs" ADD CONSTRAINT "UQ_97ee9024805b4f2abe68ed78623" UNIQUE ("requestId")`,
    );
    await queryRunner.query(`ALTER TABLE "project_specs" DROP COLUMN "status"`);

    // Check nếu enum đã tồn tại (từ migration trước) thì skip
    const typeExists = await queryRunner.query(
      `SELECT 1 FROM pg_type WHERE typname = 'project_specs_status_enum'`,
    );
    if (!typeExists || typeExists.length === 0) {
      await queryRunner.query(
        `CREATE TYPE "public"."project_specs_status_enum" AS ENUM('DRAFT', 'PENDING_APPROVAL', 'APPROVED', 'REJECTED')`,
      );
    }

    await queryRunner.query(
      `ALTER TABLE "project_specs" ADD "status" "public"."project_specs_status_enum" NOT NULL DEFAULT 'PENDING_APPROVAL'`,
    );
    await queryRunner.query(`ALTER TABLE "project_specs" ALTER COLUMN "createdAt" SET NOT NULL`);
    await queryRunner.query(
      `ALTER TYPE "public"."dispute_notes_authorrole_enum" RENAME TO "dispute_notes_authorrole_enum_old"`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."dispute_notes_authorrole_enum" AS ENUM('ADMIN', 'STAFF', 'BROKER', 'CLIENT', 'CLIENT_SME', 'FREELANCER')`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_notes" ALTER COLUMN "authorRole" TYPE "public"."dispute_notes_authorrole_enum" USING "authorRole"::"text"::"public"."dispute_notes_authorrole_enum"`,
    );
    await queryRunner.query(`DROP TYPE "public"."dispute_notes_authorrole_enum_old"`);
    await queryRunner.query(
      `ALTER TYPE "public"."disputes_raiserrole_enum" RENAME TO "disputes_raiserrole_enum_old"`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."disputes_raiserrole_enum" AS ENUM('ADMIN', 'STAFF', 'BROKER', 'CLIENT', 'CLIENT_SME', 'FREELANCER')`,
    );
    await queryRunner.query(
      `ALTER TABLE "disputes" ALTER COLUMN "raiserRole" TYPE "public"."disputes_raiserrole_enum" USING "raiserRole"::"text"::"public"."disputes_raiserrole_enum"`,
    );
    await queryRunner.query(`DROP TYPE "public"."disputes_raiserrole_enum_old"`);
    await queryRunner.query(
      `ALTER TYPE "public"."disputes_defendantrole_enum" RENAME TO "disputes_defendantrole_enum_old"`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."disputes_defendantrole_enum" AS ENUM('ADMIN', 'STAFF', 'BROKER', 'CLIENT', 'CLIENT_SME', 'FREELANCER')`,
    );
    await queryRunner.query(
      `ALTER TABLE "disputes" ALTER COLUMN "defendantRole" TYPE "public"."disputes_defendantrole_enum" USING "defendantRole"::"text"::"public"."disputes_defendantrole_enum"`,
    );
    await queryRunner.query(`DROP TYPE "public"."disputes_defendantrole_enum_old"`);
    await queryRunner.query(
      `ALTER TABLE "dispute_hearings" DROP CONSTRAINT "FK_7affb78273ec41d28d86a728829"`,
    );
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."moderatorId" IS 'Staff/Admin chủ trì phiên điều trần'`,
    );
    await queryRunner.query(
      `ALTER TYPE "public"."dispute_activities_actorrole_enum" RENAME TO "dispute_activities_actorrole_enum_old"`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."dispute_activities_actorrole_enum" AS ENUM('ADMIN', 'STAFF', 'BROKER', 'CLIENT', 'CLIENT_SME', 'FREELANCER')`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_activities" ALTER COLUMN "actorRole" TYPE "public"."dispute_activities_actorrole_enum" USING "actorRole"::"text"::"public"."dispute_activities_actorrole_enum"`,
    );
    await queryRunner.query(`DROP TYPE "public"."dispute_activities_actorrole_enum_old"`);
    await queryRunner.query(`ALTER TABLE "broker_proposals" DROP COLUMN "status"`);
    await queryRunner.query(
      `CREATE TYPE "public"."broker_proposals_status_enum" AS ENUM('PENDING', 'INVITED', 'ACCEPTED', 'REJECTED')`,
    );
    await queryRunner.query(
      `ALTER TABLE "broker_proposals" ADD "status" "public"."broker_proposals_status_enum" NOT NULL DEFAULT 'PENDING'`,
    );
    await queryRunner.query(
      `CREATE UNIQUE INDEX "IDX_5e959878bf336b30d674d43fe4" ON "broker_proposals" ("requestId", "brokerId") `,
    );
    await queryRunner.query(
      `ALTER TABLE "user_availabilities" ADD CONSTRAINT "FK_867c57e48ca1d079aca44fca934" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "user_availabilities" ADD CONSTRAINT "FK_6ae26565ff5f86a6a7c39681ca8" FOREIGN KEY ("linkedEventId") REFERENCES "calendar_events"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "staff_performances" ADD CONSTRAINT "FK_feb22f7363173d1b0ef31b66018" FOREIGN KEY ("staffId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "staff_workloads" ADD CONSTRAINT "FK_f74d45b106d825f29cc2e5b99cd" FOREIGN KEY ("staffId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    // Check xem constraint đã tồn tại chưa (từ migration C05_ProjectSpec_Final)
    const constraintExists = await queryRunner.query(
      `SELECT 1 FROM information_schema.table_constraints WHERE constraint_name = 'FK_927a9184a0da350a677aa7e6269'`,
    );
    if (!constraintExists || constraintExists.length === 0) {
      await queryRunner.query(
        `ALTER TABLE "milestones" ADD CONSTRAINT "FK_927a9184a0da350a677aa7e6269" FOREIGN KEY ("projectSpecId") REFERENCES "project_specs"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
      );
    }
    await queryRunner.query(
      `ALTER TABLE "legal_signatures" ADD CONSTRAINT "FK_3cc89eed44ba0a39380c6a08f16" FOREIGN KEY ("disputeId") REFERENCES "disputes"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "legal_signatures" ADD CONSTRAINT "FK_78dbf28b52549311a8b9ceee32f" FOREIGN KEY ("signerId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "event_participants" ADD CONSTRAINT "FK_4907f15416577c3bbbcd604d121" FOREIGN KEY ("eventId") REFERENCES "calendar_events"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "event_participants" ADD CONSTRAINT "FK_d1b1a40ec360951071605b0f7a0" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    // Check xem constraint đã tồn tại chưa (từ migration C05_ProjectSpec_Final)
    const projectSpecConstraintExists = await queryRunner.query(
      `SELECT 1 FROM information_schema.table_constraints WHERE constraint_name = 'FK_97ee9024805b4f2abe68ed78623'`,
    );
    if (!projectSpecConstraintExists || projectSpecConstraintExists.length === 0) {
      await queryRunner.query(
        `ALTER TABLE "project_specs" ADD CONSTRAINT "FK_97ee9024805b4f2abe68ed78623" FOREIGN KEY ("requestId") REFERENCES "project_requests"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
      );
    }
    await queryRunner.query(
      `ALTER TABLE "disputes" ADD CONSTRAINT "FK_d3d83cc3eaaafdd439787146ed4" FOREIGN KEY ("assignedStaffId") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "disputes" ADD CONSTRAINT "FK_e823d628afa329e33896cbffd01" FOREIGN KEY ("escalatedToAdminId") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_messages" ADD CONSTRAINT "FK_288e9a3fe13cfe14abe9824e9ce" FOREIGN KEY ("disputeId") REFERENCES "disputes"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_messages" ADD CONSTRAINT "FK_e154dd9c8d78610a275b5c72536" FOREIGN KEY ("senderId") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_messages" ADD CONSTRAINT "FK_587f533d1927b5ec42342b19edb" FOREIGN KEY ("replyToMessageId") REFERENCES "dispute_messages"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_messages" ADD CONSTRAINT "FK_dc82f55f2a951d0ef0582c9e030" FOREIGN KEY ("relatedEvidenceId") REFERENCES "dispute_evidences"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_messages" ADD CONSTRAINT "FK_c663721f6b7170bd81b6df60fcc" FOREIGN KEY ("hearingId") REFERENCES "dispute_hearings"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_hearings" ADD CONSTRAINT "FK_7affb78273ec41d28d86a728829" FOREIGN KEY ("moderatorId") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_evidences" ADD CONSTRAINT "FK_66cc1a5a31819855cf1aff32d56" FOREIGN KEY ("disputeId") REFERENCES "disputes"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_evidences" ADD CONSTRAINT "FK_85e8296ddc6ac2f0bb1aa054348" FOREIGN KEY ("uploaderId") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_evidences" ADD CONSTRAINT "FK_e99822e169b518e548bf4b72ad0" FOREIGN KEY ("flaggedById") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "event_reschedule_requests" ADD CONSTRAINT "FK_0ac7c3e37b89c3175104a8fb6c1" FOREIGN KEY ("eventId") REFERENCES "calendar_events"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "event_reschedule_requests" ADD CONSTRAINT "FK_5804d5a5bf7b121d5bbf17b1381" FOREIGN KEY ("requesterId") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "event_reschedule_requests" ADD CONSTRAINT "FK_efd9b7049628373061b4c17db01" FOREIGN KEY ("processedById") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "event_reschedule_requests" ADD CONSTRAINT "FK_f7d69babb32833a937c01c9dfcf" FOREIGN KEY ("newEventId") REFERENCES "calendar_events"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "broker_proposals" ADD CONSTRAINT "FK_e47dedae186b41203c8614a98e0" FOREIGN KEY ("requestId") REFERENCES "project_requests"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "broker_proposals" ADD CONSTRAINT "FK_cdfb328ffe79fb43e6b965076cd" FOREIGN KEY ("brokerId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "calendar_events" ADD CONSTRAINT "FK_a007ca3d443825b41461d9da45c" FOREIGN KEY ("organizerId") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "calendar_events" ADD CONSTRAINT "FK_16e7e7cc00e7fdc1ae7a4762a4e" FOREIGN KEY ("previousEventId") REFERENCES "calendar_events"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_settlements" ADD CONSTRAINT "FK_55edb94d39d55c06ec6d791e609" FOREIGN KEY ("disputeId") REFERENCES "disputes"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_settlements" ADD CONSTRAINT "FK_b18d40f213ca9be50bdba26a391" FOREIGN KEY ("proposerId") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_settlements" ADD CONSTRAINT "FK_4f739e97f1d4001972b83f55d92" FOREIGN KEY ("responderId") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_resolution_feedbacks" ADD CONSTRAINT "FK_ae1b9e4e007b9c33141e8b5fb44" FOREIGN KEY ("disputeId") REFERENCES "disputes"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_resolution_feedbacks" ADD CONSTRAINT "FK_ae7c221c89bb137ee857f8a61d6" FOREIGN KEY ("staffId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_resolution_feedbacks" ADD CONSTRAINT "FK_15ec954127ddaf6a2ccf2ed3736" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_verdicts" ADD CONSTRAINT "FK_a027522850799c0ff026bceb1cd" FOREIGN KEY ("disputeId") REFERENCES "disputes"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_verdicts" ADD CONSTRAINT "FK_c76130cead6c14ef502b45ebf87" FOREIGN KEY ("adjudicatorId") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_verdicts" ADD CONSTRAINT "FK_878605b8bb3318d5bf1032bb161" FOREIGN KEY ("overridesVerdictId") REFERENCES "dispute_verdicts"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`,
    );
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    await queryRunner.query(
      `ALTER TABLE "dispute_verdicts" DROP CONSTRAINT "FK_878605b8bb3318d5bf1032bb161"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_verdicts" DROP CONSTRAINT "FK_c76130cead6c14ef502b45ebf87"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_verdicts" DROP CONSTRAINT "FK_a027522850799c0ff026bceb1cd"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_resolution_feedbacks" DROP CONSTRAINT "FK_15ec954127ddaf6a2ccf2ed3736"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_resolution_feedbacks" DROP CONSTRAINT "FK_ae7c221c89bb137ee857f8a61d6"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_resolution_feedbacks" DROP CONSTRAINT "FK_ae1b9e4e007b9c33141e8b5fb44"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_settlements" DROP CONSTRAINT "FK_4f739e97f1d4001972b83f55d92"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_settlements" DROP CONSTRAINT "FK_b18d40f213ca9be50bdba26a391"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_settlements" DROP CONSTRAINT "FK_55edb94d39d55c06ec6d791e609"`,
    );
    await queryRunner.query(
      `ALTER TABLE "calendar_events" DROP CONSTRAINT "FK_16e7e7cc00e7fdc1ae7a4762a4e"`,
    );
    await queryRunner.query(
      `ALTER TABLE "calendar_events" DROP CONSTRAINT "FK_a007ca3d443825b41461d9da45c"`,
    );
    await queryRunner.query(
      `ALTER TABLE "broker_proposals" DROP CONSTRAINT "FK_cdfb328ffe79fb43e6b965076cd"`,
    );
    await queryRunner.query(
      `ALTER TABLE "broker_proposals" DROP CONSTRAINT "FK_e47dedae186b41203c8614a98e0"`,
    );
    await queryRunner.query(
      `ALTER TABLE "event_reschedule_requests" DROP CONSTRAINT "FK_f7d69babb32833a937c01c9dfcf"`,
    );
    await queryRunner.query(
      `ALTER TABLE "event_reschedule_requests" DROP CONSTRAINT "FK_efd9b7049628373061b4c17db01"`,
    );
    await queryRunner.query(
      `ALTER TABLE "event_reschedule_requests" DROP CONSTRAINT "FK_5804d5a5bf7b121d5bbf17b1381"`,
    );
    await queryRunner.query(
      `ALTER TABLE "event_reschedule_requests" DROP CONSTRAINT "FK_0ac7c3e37b89c3175104a8fb6c1"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_evidences" DROP CONSTRAINT "FK_e99822e169b518e548bf4b72ad0"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_evidences" DROP CONSTRAINT "FK_85e8296ddc6ac2f0bb1aa054348"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_evidences" DROP CONSTRAINT "FK_66cc1a5a31819855cf1aff32d56"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_hearings" DROP CONSTRAINT "FK_7affb78273ec41d28d86a728829"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_messages" DROP CONSTRAINT "FK_c663721f6b7170bd81b6df60fcc"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_messages" DROP CONSTRAINT "FK_dc82f55f2a951d0ef0582c9e030"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_messages" DROP CONSTRAINT "FK_587f533d1927b5ec42342b19edb"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_messages" DROP CONSTRAINT "FK_e154dd9c8d78610a275b5c72536"`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_messages" DROP CONSTRAINT "FK_288e9a3fe13cfe14abe9824e9ce"`,
    );
    await queryRunner.query(
      `ALTER TABLE "disputes" DROP CONSTRAINT "FK_e823d628afa329e33896cbffd01"`,
    );
    await queryRunner.query(
      `ALTER TABLE "disputes" DROP CONSTRAINT "FK_d3d83cc3eaaafdd439787146ed4"`,
    );
    await queryRunner.query(
      `ALTER TABLE "project_specs" DROP CONSTRAINT "FK_97ee9024805b4f2abe68ed78623"`,
    );
    await queryRunner.query(
      `ALTER TABLE "event_participants" DROP CONSTRAINT "FK_d1b1a40ec360951071605b0f7a0"`,
    );
    await queryRunner.query(
      `ALTER TABLE "event_participants" DROP CONSTRAINT "FK_4907f15416577c3bbbcd604d121"`,
    );
    await queryRunner.query(
      `ALTER TABLE "legal_signatures" DROP CONSTRAINT "FK_78dbf28b52549311a8b9ceee32f"`,
    );
    await queryRunner.query(
      `ALTER TABLE "legal_signatures" DROP CONSTRAINT "FK_3cc89eed44ba0a39380c6a08f16"`,
    );
    await queryRunner.query(
      `ALTER TABLE "milestones" DROP CONSTRAINT "FK_927a9184a0da350a677aa7e6269"`,
    );
    await queryRunner.query(
      `ALTER TABLE "staff_workloads" DROP CONSTRAINT "FK_f74d45b106d825f29cc2e5b99cd"`,
    );
    await queryRunner.query(
      `ALTER TABLE "staff_performances" DROP CONSTRAINT "FK_feb22f7363173d1b0ef31b66018"`,
    );
    await queryRunner.query(
      `ALTER TABLE "user_availabilities" DROP CONSTRAINT "FK_6ae26565ff5f86a6a7c39681ca8"`,
    );
    await queryRunner.query(
      `ALTER TABLE "user_availabilities" DROP CONSTRAINT "FK_867c57e48ca1d079aca44fca934"`,
    );
    await queryRunner.query(`DROP INDEX "public"."IDX_5e959878bf336b30d674d43fe4"`);
    await queryRunner.query(`ALTER TABLE "broker_proposals" DROP COLUMN "status"`);
    await queryRunner.query(`DROP TYPE "public"."broker_proposals_status_enum"`);
    await queryRunner.query(
      `ALTER TABLE "broker_proposals" ADD "status" character varying NOT NULL DEFAULT 'PENDING'`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."dispute_activities_actorrole_enum_old" AS ENUM('CLIENT', 'FREELANCER', 'BROKER', 'ADMIN', 'STAFF')`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_activities" ALTER COLUMN "actorRole" TYPE "public"."dispute_activities_actorrole_enum_old" USING "actorRole"::"text"::"public"."dispute_activities_actorrole_enum_old"`,
    );
    await queryRunner.query(`DROP TYPE "public"."dispute_activities_actorrole_enum"`);
    await queryRunner.query(
      `ALTER TYPE "public"."dispute_activities_actorrole_enum_old" RENAME TO "dispute_activities_actorrole_enum"`,
    );
    await queryRunner.query(`COMMENT ON COLUMN "dispute_hearings"."moderatorId" IS NULL`);
    await queryRunner.query(
      `ALTER TABLE "dispute_hearings" ADD CONSTRAINT "FK_7affb78273ec41d28d86a728829" FOREIGN KEY ("moderatorId") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."disputes_defendantrole_enum_old" AS ENUM('CLIENT', 'FREELANCER', 'BROKER', 'ADMIN', 'STAFF')`,
    );
    await queryRunner.query(
      `ALTER TABLE "disputes" ALTER COLUMN "defendantRole" TYPE "public"."disputes_defendantrole_enum_old" USING "defendantRole"::"text"::"public"."disputes_defendantrole_enum_old"`,
    );
    await queryRunner.query(`DROP TYPE "public"."disputes_defendantrole_enum"`);
    await queryRunner.query(
      `ALTER TYPE "public"."disputes_defendantrole_enum_old" RENAME TO "disputes_defendantrole_enum"`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."disputes_raiserrole_enum_old" AS ENUM('CLIENT', 'FREELANCER', 'BROKER', 'ADMIN', 'STAFF')`,
    );
    await queryRunner.query(
      `ALTER TABLE "disputes" ALTER COLUMN "raiserRole" TYPE "public"."disputes_raiserrole_enum_old" USING "raiserRole"::"text"::"public"."disputes_raiserrole_enum_old"`,
    );
    await queryRunner.query(`DROP TYPE "public"."disputes_raiserrole_enum"`);
    await queryRunner.query(
      `ALTER TYPE "public"."disputes_raiserrole_enum_old" RENAME TO "disputes_raiserrole_enum"`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."dispute_notes_authorrole_enum_old" AS ENUM('CLIENT', 'FREELANCER', 'BROKER', 'ADMIN', 'STAFF')`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_notes" ALTER COLUMN "authorRole" TYPE "public"."dispute_notes_authorrole_enum_old" USING "authorRole"::"text"::"public"."dispute_notes_authorrole_enum_old"`,
    );
    await queryRunner.query(`DROP TYPE "public"."dispute_notes_authorrole_enum"`);
    await queryRunner.query(
      `ALTER TYPE "public"."dispute_notes_authorrole_enum_old" RENAME TO "dispute_notes_authorrole_enum"`,
    );
    await queryRunner.query(`ALTER TABLE "project_specs" ALTER COLUMN "createdAt" DROP NOT NULL`);
    await queryRunner.query(`ALTER TABLE "project_specs" DROP COLUMN "status"`);
    await queryRunner.query(`DROP TYPE "public"."project_specs_status_enum"`);
    await queryRunner.query(
      `ALTER TABLE "project_specs" ADD "status" character varying(50) DEFAULT 'DRAFT'`,
    );
    await queryRunner.query(
      `ALTER TABLE "project_specs" DROP CONSTRAINT "UQ_97ee9024805b4f2abe68ed78623"`,
    );
    await queryRunner.query(
      `CREATE TYPE "public"."project_requests_status_enum_old" AS ENUM('PENDING', 'PROCESSING', 'APPROVED', 'REJECTED', 'CANCELED', 'DRAFT', 'PUBLIC_DRAFT', 'PRIVATE_DRAFT', 'PENDING_SPECS', 'HIRING', 'IN_PROGRESS', 'COMPLETED', 'BROKER_ASSIGNED', 'SPEC_APPROVED', 'CONTRACT_PENDING', 'CONVERTED_TO_PROJECT', 'SPEC_SUBMITTED')`,
    );
    await queryRunner.query(`ALTER TABLE "project_requests" ALTER COLUMN "status" DROP DEFAULT`);
    await queryRunner.query(
      `ALTER TABLE "project_requests" ALTER COLUMN "status" TYPE "public"."project_requests_status_enum_old" USING "status"::"text"::"public"."project_requests_status_enum_old"`,
    );
    await queryRunner.query(
      `ALTER TABLE "project_requests" ALTER COLUMN "status" SET DEFAULT 'PENDING'`,
    );
    await queryRunner.query(`DROP TYPE "public"."project_requests_status_enum"`);
    await queryRunner.query(
      `ALTER TYPE "public"."project_requests_status_enum_old" RENAME TO "project_requests_status_enum"`,
    );
    await queryRunner.query(`ALTER TABLE "milestones" ALTER COLUMN "amount" TYPE numeric(15,2)`);
    await queryRunner.query(
      `COMMENT ON COLUMN "hearing_participants"."declineReason" IS 'Lý do từ chối/xin dời'`,
    );
    await queryRunner.query(`ALTER TABLE "hearing_participants" DROP COLUMN "declineReason"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "hearing_participants"."responseDeadline" IS 'Hạn phản hồi lời mời'`,
    );
    await queryRunner.query(`ALTER TABLE "hearing_participants" DROP COLUMN "responseDeadline"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "hearing_participants"."isRequired" IS 'Bắt buộc tham gia (Nguyên đơn, Bị đơn = true)'`,
    );
    await queryRunner.query(`ALTER TABLE "hearing_participants" DROP COLUMN "isRequired"`);
    await queryRunner.query(`ALTER TABLE "dispute_hearings" DROP COLUMN "lastRescheduledAt"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."previousHearingId" IS 'Phiên cũ nếu đây là reschedule'`,
    );
    await queryRunner.query(`ALTER TABLE "dispute_hearings" DROP COLUMN "previousHearingId"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."rescheduleCount" IS 'Số lần đã dời lịch (Max 2-3)'`,
    );
    await queryRunner.query(`ALTER TABLE "dispute_hearings" DROP COLUMN "rescheduleCount"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."estimatedDurationMinutes" IS 'Thời lượng dự kiến (phút)'`,
    );
    await queryRunner.query(
      `ALTER TABLE "dispute_hearings" DROP COLUMN "estimatedDurationMinutes"`,
    );
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."isChatRoomActive" IS 'TRUE = Phòng chat đang hoạt động'`,
    );
    await queryRunner.query(`ALTER TABLE "dispute_hearings" DROP COLUMN "isChatRoomActive"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."tier" IS 'Tier 1 = Staff, Tier 2 = Admin phúc thẩm'`,
    );
    await queryRunner.query(`ALTER TABLE "dispute_hearings" DROP COLUMN "tier"`);
    await queryRunner.query(`DROP TYPE "public"."dispute_hearings_tier_enum"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."currentSpeakerRole" IS 'Kiểm soát ai được quyền chat hiện tại'`,
    );
    await queryRunner.query(`ALTER TABLE "dispute_hearings" DROP COLUMN "currentSpeakerRole"`);
    await queryRunner.query(`DROP TYPE "public"."dispute_hearings_currentspeakerrole_enum"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "dispute_hearings"."externalMeetingLink" IS 'Link Google Meet/Zoom nếu cần video call (optional, do bên thứ 3 cung cấp)'`,
    );
    await queryRunner.query(`ALTER TABLE "dispute_hearings" DROP COLUMN "externalMeetingLink"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."appealDeadline" IS 'Hạn kháng cáo (3 ngày sau resolve)'`,
    );
    await queryRunner.query(`ALTER TABLE "disputes" DROP COLUMN "appealDeadline"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."settlementAttempts" IS 'Số lần đề xuất hòa giải bị reject (max 3)'`,
    );
    await queryRunner.query(`ALTER TABLE "disputes" DROP COLUMN "settlementAttempts"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."isAutoResolved" IS 'TRUE = Auto-win do bị đơn không phản hồi'`,
    );
    await queryRunner.query(`ALTER TABLE "disputes" DROP COLUMN "isAutoResolved"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."acceptedSettlementId" IS 'Settlement đã được accept (nếu có)'`,
    );
    await queryRunner.query(`ALTER TABLE "disputes" DROP COLUMN "acceptedSettlementId"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."escalationReason" IS 'Lý do escalate lên Admin'`,
    );
    await queryRunner.query(`ALTER TABLE "disputes" DROP COLUMN "escalationReason"`);
    await queryRunner.query(`ALTER TABLE "disputes" DROP COLUMN "escalatedAt"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."escalatedToAdminId" IS 'Admin phúc thẩm (nếu escalate)'`,
    );
    await queryRunner.query(`ALTER TABLE "disputes" DROP COLUMN "escalatedToAdminId"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."currentTier" IS '1 = Staff xử lý, 2 = Admin phúc thẩm'`,
    );
    await queryRunner.query(`ALTER TABLE "disputes" DROP COLUMN "currentTier"`);
    await queryRunner.query(`ALTER TABLE "disputes" DROP COLUMN "assignedAt"`);
    await queryRunner.query(
      `COMMENT ON COLUMN "disputes"."assignedStaffId" IS 'Staff được gán xử lý'`,
    );
    await queryRunner.query(`ALTER TABLE "disputes" DROP COLUMN "assignedStaffId"`);
    await queryRunner.query(`ALTER TABLE "dispute_hearings" ADD "meetingLink" character varying`);
    await queryRunner.query(`DROP TABLE "dispute_verdicts"`);
    await queryRunner.query(`DROP TYPE "public"."dispute_verdicts_faulttype_enum"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_ae13f5b449f0c4eb0355461e25"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_7c5efa28f1cc59dcb589c07c90"`);
    await queryRunner.query(`DROP TABLE "dispute_resolution_feedbacks"`);
    await queryRunner.query(`DROP TABLE "auto_schedule_rules"`);
    await queryRunner.query(`DROP TYPE "public"."auto_schedule_rules_strategy_enum"`);
    await queryRunner.query(`DROP TYPE "public"."auto_schedule_rules_eventtype_enum"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_dac8e51dee0245e76de7099fc5"`);
    await queryRunner.query(`DROP TABLE "dispute_settlements"`);
    await queryRunner.query(`DROP TYPE "public"."dispute_settlements_status_enum"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_fb3f2230a784122307b26d18a3"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_11c123605d5b0aa135a5283321"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_764bd953684c413eea5bd3059a"`);
    await queryRunner.query(`DROP TABLE "calendar_events"`);
    await queryRunner.query(`DROP TYPE "public"."calendar_events_status_enum"`);
    await queryRunner.query(`DROP TYPE "public"."calendar_events_priority_enum"`);
    await queryRunner.query(`DROP TYPE "public"."calendar_events_type_enum"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_3108804238a667da7d826fba4b"`);
    await queryRunner.query(`DROP TABLE "event_reschedule_requests"`);
    await queryRunner.query(`DROP TYPE "public"."event_reschedule_requests_status_enum"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_de7b1e3103a486f694fedc726f"`);
    await queryRunner.query(`DROP TABLE "dispute_evidences"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_a9cbc17b602d6612732446411e"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_b00e523249685dadae620f80e4"`);
    await queryRunner.query(`DROP TABLE "dispute_messages"`);
    await queryRunner.query(`DROP TYPE "public"."dispute_messages_type_enum"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_7d90a2ab3ea972461a2b698adc"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_845042ee2b14702b78b0428d19"`);
    await queryRunner.query(`DROP TABLE "event_participants"`);
    await queryRunner.query(`DROP TYPE "public"."event_participants_attendancestatus_enum"`);
    await queryRunner.query(`DROP TYPE "public"."event_participants_status_enum"`);
    await queryRunner.query(`DROP TYPE "public"."event_participants_role_enum"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_e8063ccf1d8a6844462602e379"`);
    await queryRunner.query(`DROP TABLE "legal_signatures"`);
    await queryRunner.query(`DROP TYPE "public"."legal_signatures_actiontype_enum"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_6ea8194aa51f091685b7189c83"`);
    await queryRunner.query(`DROP TABLE "staff_workloads"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_f470385602469dc1fb0615d4c6"`);
    await queryRunner.query(`DROP TABLE "staff_performances"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_e377a1b2968a22e35e20494d50"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_ac1cbe4c27fbb852c69edc736d"`);
    await queryRunner.query(`DROP TABLE "user_availabilities"`);
    await queryRunner.query(`DROP TYPE "public"."user_availabilities_type_enum"`);
    await queryRunner.query(
      `CREATE UNIQUE INDEX "IDX_broker_proposal_request_broker" ON "broker_proposals" ("brokerId", "requestId") `,
    );
    await queryRunner.query(
      `ALTER TABLE "broker_proposals" ADD CONSTRAINT "FK_broker_proposals_request" FOREIGN KEY ("requestId") REFERENCES "project_requests"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "broker_proposals" ADD CONSTRAINT "FK_broker_proposals_broker" FOREIGN KEY ("brokerId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
    await queryRunner.query(
      `ALTER TABLE "project_specs" ADD CONSTRAINT "project_specs_requestId_fkey" FOREIGN KEY ("requestId") REFERENCES "project_requests"("id") ON DELETE CASCADE ON UPDATE NO ACTION`,
    );
  }
}
